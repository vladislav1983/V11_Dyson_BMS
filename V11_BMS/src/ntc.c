/*
 * ntc.c
 *
 * Created: 21-Jan-26 10:02:57
 *  Author: Vladislav Gyurov
 */ 
 /*-----------------------------------------------------------------------------
    INCLUDE FILES
-----------------------------------------------------------------------------*/
#include "ntc.h"

/*-----------------------------------------------------------------------------
    DEFINITION OF GLOBAL VARIABLES
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DEFINITION OF GLOBAL CONSTANTS
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DECLARATION OF LOCAL FUNCTIONS
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DECLARATION OF LOCAL MACROS/#DEFINES
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DEFINITION OF LOCAL TYPES
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DEFINITION OF LOCAL VARIABLES
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DEFINITION OF LOCAL CONSTANTS
-----------------------------------------------------------------------------*/
/**
* The NTC table has 129 interpolation points.
* Unit:0.1 °C
*
*/
int16_t NTC_table[129] = {
  1956, 1607, 1258, 1078, 958, 870, 800, 743,
  694, 652, 615, 582, 552, 525, 500, 477, 455,
  435, 416, 398, 381, 365, 350, 335, 321, 308,
  295, 282, 270, 259, 247, 236, 226, 216, 205,
  196, 186, 177, 168, 159, 150, 141, 133, 125,
  116, 108, 101, 93, 85, 78, 70, 63, 56, 48,
  41, 34, 27, 20, 13, 7, 0, -7, -13, -20, -27,
  -33, -40, -46, -53, -59, -66, -72, -78, -85,
  -91, -98, -104, -111, -117, -123, -130, -136,
  -143, -150, -156, -163, -169, -176, -183,
  -190, -197, -204, -211, -218, -225, -232,
  -239, -247, -255, -262, -270, -278, -286,
  -295, -303, -312, -321, -331, -340, -350,
  -360, -371, -382, -394, -406, -419, -432,
  -447, -462, -479, -497, -517, -540, -566,
  -597, -635, -686, -767, -848
};

/*-----------------------------------------------------------------------------
    DEFINITION OF LOCAL FUNCTIONS PROTOTYPES
-----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
    DEFINITION OF GLOBAL FUNCTIONS
-----------------------------------------------------------------------------*/
//- **************************************************************************
//! \brief 
//- **************************************************************************
/**
* \brief    Converts the ADC result into a temperature value.
*
*           P1 and p2 are the interpolating point just before and after the
*           ADC value. The function interpolates between these two points
*           The resulting code is very small and fast.
*           Only one integer multiplication is used.
*           The compiler can replace the division by a shift operation.
*
*           In the temperature range from -45°C to 80°C the error
*           caused by the usage of a table is 0.213°C
*
* \param    adc_value  The converted ADC result
* \return              The temperature in 0.1 °C
*
*/
int16_t NTC_ADC2Temperature(uint16_t adc_value)
{ 
  int16_t p1,p2;
  uint32_t adc_value_norm_u32;
  uint16_t adc_value_norm_u16;

  // normalize ADC with Vref = (3.3V / 1.48) to 3.3V
  // normalized value should be LSB / 1.48
  adc_value_norm_u32 = (uint32_t)adc_value * (uint16_t)(32768.0 / 1.48);
  adc_value_norm_u16 = (uint16_t)(adc_value_norm_u32 >> 15);

  /* Estimate the interpolating point before and after the ADC value. */
  p1 = NTC_table[ (adc_value_norm_u16 >> 5)  ];
  p2 = NTC_table[ (adc_value_norm_u16 >> 5)+1];
  
  /* Interpolate between both points. */
  return p1 - ( (p1-p2) * (adc_value_norm_u16 & 0x001F) ) / 32;
};

/*-----------------------------------------------------------------------------
    DEFINITION OF LOCAL FUNCTIONS
-----------------------------------------------------------------------------*/
//- **************************************************************************
//! \brief 
//- **************************************************************************

/*-----------------------------------------------------------------------------
    END OF MODULE
-----------------------------------------------------------------------------*/